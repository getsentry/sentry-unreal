name: Build UE Windows Docker image

on:
  workflow_dispatch:
    inputs:
      ue_version:
        description: Select Unreal Engine version
        required: true
        type: choice
        options:
        - 4.27
        - 5.0
        - 5.1
        - 5.2
        - 5.3
        - 5.4
        - 5.5
        - 5.6
        - 5.7
      ue_repo:
        description: Set Unreal Engine repository
        required: true
        type: string
        default: 'https://github.com/getsentry/UnrealEngine.git'
      clean_disk:
        description: Clean up disk space before Docker build
        required: true
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io

jobs:
  build:
    name: 'Build for UE ${{ inputs.ue_version }}'
    runs-on: windows-latest-32-cores

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Building docker images for newer UE versions may require extra disk space
      - name: Clean up disk space before Docker build
        if: ${{ inputs.clean_disk == true }}
        shell: pwsh
        run: |
          .\scripts\clean-storage-win.ps1

      - name: Set Visual Studio version based on UE version
        id: set_vs_version
        shell: bash
        env:
          UE_VERSION: ${{ inputs.ue_version }}
        run: |
          if [[ "$UE_VERSION" == "4.27" || "$UE_VERSION" == "5.0" || "$UE_VERSION" == "5.1" ]]; then
            echo "vs_version=2019" >> $GITHUB_OUTPUT
          else
            echo "vs_version=2022" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.8'
          architecture: 'x64'

      - name: Install unreal-docker
        run: |
            # Use PR #384 which dynamically determines VS components from Windows_SDK.json
            Invoke-WebRequest -Uri "https://github.com/slonopotamus/ue4-docker/archive/refs/heads/windows_sdk.json.zip" -OutFile "ue-docker.zip"
            Expand-Archive -Path "ue-docker.zip" -DestinationPath "."
            cd ue4-docker-windows_sdk.json
            pip install -e .

      - name: Pre-configure Docker storage to avoid ue4-docker setup restart issue
        run: |
          # Pre-configure Docker storage limit BEFORE running ue4-docker setup
          # This way, setup will see it's already configured and skip the Docker restart
          # which fails with error 1056 when Docker is already running

          # Stop Docker to modify daemon.json
          Stop-Service -Name docker -Force
          Write-Host "Docker stopped for configuration"

          # Configure Docker daemon with 800GB storage limit
          $daemonConfig = @{
            "storage-opts" = @("size=800GB")
          }
          $daemonConfig | ConvertTo-Json | Set-Content -Path "C:\ProgramData\docker\config\daemon.json" -Force
          Write-Host "Configured Docker storage limit to 800GB"

          # Start Docker
          Start-Service -Name docker
          Write-Host "Docker started"

          # Wait for Docker to be ready
          $timeout = 60
          $elapsed = 0
          while ($elapsed -lt $timeout) {
            try {
              docker info | Out-Null
              Write-Host "Docker is ready"
              break
            } catch {
              Write-Host "Waiting for Docker to start..."
              Start-Sleep -Seconds 2
              $elapsed += 2
            }
          }

      - name: Run ue4-docker setup for credential endpoint configuration
        run: |
          ue4-docker setup

      - name: Build Unreal Engine Docker image
        env:
          UE_REPO: ${{ inputs.ue_repo }}
          UE_VERSION: ${{ inputs.ue_version }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
          VS_VERSION: ${{ steps.set_vs_version.outputs.vs_version }}
        run: |
          ue4-docker build custom -repo="$env:UE_REPO" -branch="$env:UE_VERSION" `
          -basetag ltsc2025 `
          -suffix "$env:UE_VERSION" `
          -isolation=process `
          -username="$env:DOCKER_USERNAME" `
          -password="$env:DOCKER_TOKEN" `
          --target minimal `
          --exclude debug `
          --exclude templates `
          --exclude ddc `
          --opt buildgraph-args="-set:WithClient=false -set:WithServer=false"

      - name: Log in to GitHub package registry
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and push Docker image with pre-built Unreal Engine
        env:
          UE_VERSION: ${{ inputs.ue_version }}
        run: |
          docker tag "adamrehn/ue4-minimal:custom-$env:UE_VERSION" "$env:REGISTRY/getsentry/unreal-docker:$env:UE_VERSION"
          docker push "$env:REGISTRY/getsentry/unreal-docker:$env:UE_VERSION"
