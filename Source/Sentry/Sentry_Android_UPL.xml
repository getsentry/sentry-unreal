<?xml version="1.0" encoding="utf-8"?>
<root xmlns:android="http://schemas.android.com/apk/res/android">
    <init>
        <log text="Sentry SDK Android UPL initialization"/>

        <setBoolFromProperty result="bUploadSymbols" ini="Engine" section="/Script/Sentry.SentrySettings" property="UploadSymbolsAutomatically" default="true" />
        <setStringFromProperty result="ProjectName" ini="Engine" section="/Script/Sentry.SentrySettings" property="ProjectName"/>
        <setStringFromProperty result="OrganisationName" ini="Engine" section="/Script/Sentry.SentrySettings" property="OrganisationName"/>
        <setStringFromProperty result="AuthToken" ini="Engine" section="/Script/Sentry.SentrySettings" property="AuthToken"/>
    </init>

    <prebuildCopies>
        <copyDir src="$S(PluginDir)/Private/Android/Java" dst="$S(BuildDir)/src/com/sentry/unreal" />
        <copyFile src="$S(PluginDir)/../../Resources/sentry.properties" dst="$S(BuildDir)/gradle/sentry.properties" />
    </prebuildCopies>

    <AARImports>
        <insertValue value="repository $S(PluginDir)/../ThirdParty/Android"/>
        <insertNewline/>
        <insert>
            io.sentry,sentry,6.3.1
            io.sentry,sentry-android-core,6.3.1
            io.sentry,sentry-android-ndk,6.3.1
        </insert>
        <insertNewline/>
    </AARImports>

    <androidManifestUpdates>
        <addElements tag="application">
            <meta-data android:name="io.sentry.auto-init" android:value="false"/>
            <meta-data android:name="io.sentry.sdk.name" android:value="sentry.java.android.unreal"/>
        </addElements>
    </androidManifestUpdates>

    <gradleProperties>
        <insert>
            android.useAndroidX=true
            android.enableJetifier=true
        </insert>
    </gradleProperties>

    <proguardAdditions>
        <insert>
            -dontwarn com.sentry.unreal.**
            -keep class com.sentry.unreal.** { *; }
            -keep class io.sentry.** { *; }
            -keep interface com.sentry.unreal.** { *; }
            -keep interface io.sentry.** { *; }
        </insert>
    </proguardAdditions>

    <buildGradleAdditions>
        <if condition="bUploadSymbols">
            <true>
                <insert>
                    apply plugin: 'io.sentry.android.gradle'

                    sentry {
                        uploadNativeSymbols = true
                        includeNativeSources = true
                    }
                </insert>
            </true>
        </if>
    </buildGradleAdditions>

    <buildGradleAdditions>
        <insert>
            android {
                compileOptions {
                    targetCompatibility JavaVersion.VERSION_1_8
                    sourceCompatibility JavaVersion.VERSION_1_8
                }
            }

            dependencies {
                implementation fileTree(dir: 'libs', include: ['*.aar', '*.jar'])
            }

            repositories {
                mavenCentral()
            }
        </insert>
    </buildGradleAdditions>

    <baseBuildGradleAdditions>
        <insert>
            allprojects {
                def mappings = [
                    'android.arch.lifecycle.Lifecycle': 'androidx.lifecycle.Lifecycle',
                    'android.arch.lifecycle.LifecycleObserver': 'androidx.lifecycle.LifecycleObserver',
                    'android.arch.lifecycle.OnLifecycleEvent': 'androidx.lifecycle.OnLifecycleEvent',
                    'android.arch.lifecycle.ProcessLifecycleOwner': 'androidx.lifecycle.ProcessLifecycleOwner',
                    'android.arch.lifecycle': 'androidx.lifecycle',
                    'android.support.annotation': 'androidx.annotation',
                    'android.support.v13.app.FragmentCompat': 'androidx.legacy.app.FragmentCompat',
                    'android.support.v4.app.ActivityCompat': 'androidx.core.app.ActivityCompat',
                    'android.support.v4.app.NotificationCompat': 'androidx.core.app.NotificationCompat',
                    'android.support.v4.app.NotificationManagerCompat': 'androidx.core.app.NotificationManagerCompat',
                    'android.support.v4.content.ContextCompat': 'androidx.core.content.ContextCompat',
                    'android.support.v4.content.FileProvider': 'androidx.core.content.FileProvider',
                ]
    
                beforeEvaluate { project ->
                    project.rootProject.projectDir.traverse(type: groovy.io.FileType.FILES, nameFilter: ~/.*\.java$/) { f ->
                        mappings.each { entry ->
                            if (f.getText('UTF-8').contains(entry.key)) {
                                println "Updating ${entry.key} to ${entry.value} in file ${f}"
                                ant.replace(file: f, token: entry.key, value: entry.value)
                            }
                        }
                    }
                }
            }
        </insert>
    </baseBuildGradleAdditions>
    
    <baseBuildGradleAdditions>
        <if condition="bUploadSymbols">
            <true>
                <insert>
                    allprojects {
                        beforeEvaluate { project ->
                            project.rootProject.projectDir.traverse(type: groovy.io.FileType.FILES, nameFilter: ~/sentry\.properties$/) { f ->
                </insert>
                <insertValue value="ant.replace(file: f, token: 'your-project', value: '$S(ProjectName)')"/>
                <insertNewline/>
                <insertValue value="ant.replace(file: f, token: 'your-org', value: '$S(OrganisationName)')"/>
                <insertNewline/>
                <insertValue value="ant.replace(file: f, token: 'YOUR_AUTH_TOKEN', value: '$S(AuthToken)')"/>
                <insertNewline/>
                <insert>
                            }
                        }
                    }
                </insert>
            </true>
        </if>
    </baseBuildGradleAdditions>

    <buildscriptGradleAdditions>
        <insert>
            dependencies {
                classpath 'com.android.tools.build:gradle:3.5.4'
            }
        </insert>
    </buildscriptGradleAdditions>

    <buildscriptGradleAdditions>
        <if condition="bUploadSymbols">
            <true>
                <insert>
                    dependencies {
                        classpath 'io.sentry:sentry-android-gradle-plugin:2.1.5'
                    }
                </insert>
            </true>
        </if>
    </buildscriptGradleAdditions>
</root>